---
article: false
date: 2024-11-09
index: true
order: 6
headerDepth: 1


---

# Network FAQ

## 网络模型

### 七层架构

1. **物理层**：负责处理电气和物理规范，如电压、线路规范、数据速率、最大传输距离等。
2. **数据链路层**：负责从物理层接收的原始比特流转换为数据帧，进行物理地址（MAC）寻址，同时也处理错误检测和校正。
3. **网络层**：负责数据包的发送和接收，包括IP地址处理和路由。
4. **传输层**：负责提供端到端的通信服务，如数据的分段、传输和重组，以及错误检测和纠正。TCP和UDP都工作在这一层。
5. **会话层**：负责建立、管理和终止会话。
6. **表示层**：负责数据的转换、加密和解密、压缩和解压缩等。
7. **应用层**：负责提供网络服务，如HTTP、FTP、SMTP等协议都工作在这一层。

### 四层模型

1. **网络接口层**：相当于OSI模型的物理层和数据链路层，负责处理物理硬件（MAC) 地址和网络接口的细节。
2. **网络层**：相当于OSI模型的网络层，负责处理IP地址和路由。
3. **传输层**：相当于OSI模型的传输层，处理TCP和UDP协议。
4. **应用层**：相当于OSI模型的会话层、表示层和应用层，处理高级应用协议和用户交互。

### FAQ

**在 TCP 上来说，对于运营商来说，如果客户端没有发起请求，服务器能够直接给客户端终端发数据包吗？理论上能实现吗？**

1. TCP（传输控制协议）和 UDP（用户数据报协议）是传输层协议，它们处理的是数据包的传输，而不是具体的请求和响应。
2. Request / Response 是 HTTP 的规范，不是 TCP 的规范。
3. **从网络层的角度看，服务器可以向任何IP地址发送数据包**
4. 如果服务器发送数据包到一个未建立TCP连接的客户端，那么客户端的网络层确实可以收到这个数据包。
5. 但是在更高的传输层，由于没有对应的TCP连接，客户端会认为这是一个无效的数据包，所以会丢弃它，而不是处理它。
6. 如果TCP连接已经建立，那么服务器是可以主动发送数据给客户端的。
7. 家庭 NAT 或者 终端的网络防火墙可能会拦截这类数据包。

**在UDP上来说，如果客户端没有发起请求，服务器能够直接给客户端发数据包吗？理论上能实现吗？**

1. 在UDP协议中，服务器确实可以直接向客户端发送数据包，即使客户端没有发起请求。
2. 因为UDP是无连接的，即它不需要预先建立一个连接才能发送数据。只要服务器知道客户端的IP地址和端口号，它就可以向客户端发送数据。
3. 如果客户端没有预期接收到这个数据包，那么它可能会忽略这个数据包，或者如果它正在使用一个防火墙或其他安全措施，它可能会把这个数据包视为未经请求的入侵尝试，并将其丢弃。
4. 此外，一些网络设备，如NAT（网络地址转换）设备，可能会阻止未经请求的入站数据包到达客户端。这是因为NAT设备通常只允许从内部网络发起的数据流通过，并且只允许来自这些数据流的响应数据包返回。即家庭 NAT 或者 终端的网络防火墙可能会拦截这类数据包。
5. 这就是为什么在许多情况下，客户端需要首先向服务器发送一个请求，以"打开"一个可以让服务器的响应返回的路径。

## UDP

### 限流

运营商或ISP（Internet Service Provider）可以通过多种方式来限制（或塑形）UDP或其他类型的网络流量。以下是一些常见的方法：

1. **带宽限制**：ISP可以限制特定类型的流量的总带宽，
   - 例如将所有UDP流量限制在一定的速率内。
   - 这可以通过监控传入和传出的数据包，并丢弃或延迟超过限制的数据包来实现。
2. **深度包检查（Deep Packet Inspection, DPI）**：DPI是一种网络数据包过滤方法，可以识别、分类和处理网络流量。
   - ISP可以使用DPI来识别特定类型的UDP流量（例如特定的应用程序或服务），然后对这些流量进行限制。
3. **流量整形（Traffic Shaping）**：ISP可以使用流量整形技术，例如漏桶（Leaky Bucket）或令牌桶（Token Bucket）算法，来控制网络流量的速率。
   - 这些算法可以平滑网络流量，并限制突发流量。
4. **优先级队列（Priority Queuing）**：ISP还可以使用优先级队列技术
   - 根据数据包的优先级（例如服务质量QoS标记）来处理数据包。
   - 低优先级的流量可能会被延迟或丢弃，以确保高优先级流量的传输。

### FAQ

**通过丢包的方式能够限流UDP的流量吗？**

是的，通过丢弃数据包的方式，运营商可以限制UDP的流量。这种方法通常被称为"流量整形"或"流量控制"。

这种丢包的方法可以有效地限制UDP流量，但也有一些缺点。

- 首先，丢弃数据包可能会导致应用性能下降，尤其是对于需要高质量数据传输的应用（如视频流）。
- 其次，UDP本身没有提供任何的错误恢复机制，所以一旦数据包被丢弃，发送方不会知道，也无法重新发送这些数据包。

## TCP

![1731162708160.png](https://pic.hanjiaming.com.cn/2024/11/09/3365539a67fd2.png)

### 三次握手

1. **SYN步骤**：客户端发送一个数据包给服务器端，数据包中包含客户端的初始序列号。这个步骤将客户端的序列号设置为X。
2. **SYN + ACK步骤**
   - 服务器收到客户端的SYN包，需要对这个SYN包进行确认，此时，服务器会设置确认号为X+1。
   - 同时，服务器也会发送一个SYN请求信息，且会把自己的初始序列号设置为Y。
3. **ACK步骤**：客户端收到服务器的SYN+ACK包，会向服务器发送确认包ACK。确认包的确认号为Y+1，序列号为X+1。

### 为什么三次

我们的目标是，为了确保可靠，我们需要让客户端终端和服务端同时确认对方都能够接受到自己的消息。

- 说法一：三次握手的主要目标是同步双方的初始序列号，以此建立可靠的连接。
- 说法二：TCP使用三次握手来创建一个**可靠的连接**，这是为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。

假设我们只进行一次或者两次握手，可能会出现以下问题：

#### 一次握手

如果只进行一次握手，客户端不知道连接是否已经建立。后续的任何通信都是不可靠的。

#### 两次握手

即使进行两次握手，也存在问题。

- 服务器确认：服务器能收到消息
- 客户端确认：服务器能收到消息，客户端能够收到消息

**服务器不知道自己的消息是否被客户端接收。**

### 四次挥手



